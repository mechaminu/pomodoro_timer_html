<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Pomodoro (Ring)</title>
<meta name="theme-color" content="#0ea5e9">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{
  --bg:#f7f9fc; --card:#ffffff; --ink:#121417; --muted:#6b7280;
  --work:#e11d48; --break:#16a34a; --ring-bg:#e5e7eb;
  --shadow:0 6px 24px rgba(0,0,0,0.08);
  --radius:160px;
}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
.container{max-width:560px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.brand{font-weight:700;font-size:18px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-size:15px;cursor:pointer}
button.primary{background:#0ea5e9;color:#fff}
button.ghost{background:#eef2f7;color:#111827}
button.warn{background:#f59e0b;color:#111827}
button.danger{background:#ef4444;color:#fff}
button:disabled{opacity:.55;cursor:not-allowed}

.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.center{display:flex;flex-direction:column;align-items:center;gap:12px}

.dial{position:relative;width:320px;height:320px;display:grid;place-items:center;touch-action:manipulation}
svg{width:100%;height:100%}
.time{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
.time h1{margin:0;font-size:40px;letter-spacing:0.5px}
.time p{margin:6px 0 0;color:var(--muted);font-size:14px}

.badge{display:inline-flex;gap:8px}
.badge span{padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;font-size:13px;cursor:pointer;user-select:none}
.badge span.active{background:#111827;color:#fff;border-color:#111827}
.badge .work{--c:var(--work)} .badge .break{--c:var(--break)}
.badge span::before{content:"";display:inline-block;width:10px;height:10px;border-radius:999px;background:var(--c);margin-right:6px;vertical-align:middle}

/* Overlay + Modals (Options / Durations) */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
.overlay.show{display:flex}
.modal{width:100%;max-width:560px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.modal h2{margin:0 0 12px;font-size:18px}
.row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eef1f4}
.row:last-child{border-bottom:0}
.group-title{margin:12px 0 4px;color:#374151;font-weight:600;font-size:14px}
.switch{position:relative;width:48px;height:28px;background:#e6e9ee;border-radius:999px;cursor:pointer}
.switch input{display:none}
.switch .knob{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:999px;box-shadow:0 2px 6px rgba(0,0,0,0.15);transition:left .2s}
.switch input:checked + .knob{left:23px}
.switch.on { background: #4caf50; } /* ON 상태 초록색 */
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}

.input{display:flex;gap:8px;align-items:center}
.input input{width:110px;padding:10px;border-radius:10px;border:1px solid #e5e7eb;font-size:15px}
.err{color:#b91c1c;font-size:12px;margin-top:6px}

/* 배경 플래시 */
@keyframes flashBg{0%,100%{background-color:var(--bg)}50%{background-color:#ffe6e6}}
.flash{animation:flashBg .8s ease-in-out infinite}

/* Debug tools in Options */
.debug-tools{display:none;gap:8px;flex-wrap:wrap;margin-top:10px}
.debug-on .debug-tools{display:flex}
.hint{color:var(--muted);font-size:12px;margin-top:2px}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">Pomodoro</div>
      <div class="controls">
        <button class="ghost" id="resetBtn">Reset</button>
        <button class="ghost" id="durBtn" aria-haspopup="dialog" aria-controls="durModal">Durations</button>
        <button class="ghost" id="optionsBtn" aria-haspopup="dialog" aria-controls="optionsModal">Options</button>
      </div>
    </div>

    <div class="card center">
      <div class="badge" role="tablist" aria-label="Mode">
        <span id="workBtn" class="work active" role="tab" aria-selected="true">Work</span>
        <span id="breakBtn" class="break" role="tab" aria-selected="false">Break</span>
      </div>

      <div class="dial" id="dial" aria-label="Timer (tap to start/pause)">
        <svg viewBox="0 0 360 360" aria-hidden="true">
          <circle cx="180" cy="180" r="160" fill="none" stroke="var(--ring-bg)" stroke-width="20"/>
          <circle id="ring" cx="180" cy="180" r="160" fill="none" stroke="var(--work)" stroke-width="20"
                  stroke-linecap="round" transform="rotate(-90 180 180)"/>
        </svg>
        <div class="time" id="timePane">
          <div>
            <h1 id="timeText">25:00</h1>
            <p id="subText">탭하여 시작/일시정지</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 옵션 모달 -->
  <div class="overlay" id="overlayOpt" role="dialog" aria-modal="true" aria-labelledby="modalTitleOpt">
    <div class="modal" id="optionsModal">
      <h2 id="modalTitleOpt">알림 옵션</h2>

      <div class="row">
        <div>사운드 재생</div>
        <label class="switch">
          <input type="checkbox" id="optSound"><span class="knob"></span>
        </label>
      </div>
      <div class="row">
        <div>진동</div>
        <label class="switch">
          <input type="checkbox" id="optVibrate"><span class="knob"></span>
        </label>
      </div>
      <div class="row">
        <div>배경 깜빡임(Flash)</div>
        <label class="switch">
          <input type="checkbox" id="optFlash"><span class="knob"></span>
        </label>
      </div>

      <div class="row">
        <div>
          디버그 모드(수동 트리거)
          <div class="hint">타이머 종료와 관계없이 아래 테스트 버튼으로 즉시 알림 실행</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="optDebug"><span class="knob"></span>
        </label>
      </div>

      <div id="debugTools" class="debug-tools" aria-live="polite">
        <button class="ghost" id="btnTestSound">사운드 테스트</button>
        <button class="ghost" id="btnTestVibrate">진동 테스트</button>
        <button class="ghost" id="btnTestFlash">플래시 테스트</button>
        <button class="warn"  id="btnTestSelected">선택 옵션 미리보기</button>
        <button class="danger" id="btnTestAll">모두 실행(강제)</button>
      </div>

      <div class="actions">
        <button class="ghost" id="closeOptsBtn">닫기</button>
        <button class="primary" id="saveOptsBtn">저장</button>
      </div>
    </div>
  </div>

  <!-- Durations 모달 -->
  <div class="overlay" id="overlayDur" role="dialog" aria-modal="true" aria-labelledby="modalTitleDur">
    <div class="modal" id="durModal">
      <h2 id="modalTitleDur">Durations (분)</h2>
      <div class="row">
        <label for="inWork" class="input">
          <span style="width:70px;">Work</span>
          <input id="inWork" type="number" min="1" max="180" step="1" inputmode="numeric" />
        </label>
      </div>
      <div class="row">
        <label for="inBreak" class="input">
          <span style="width:70px;">Break</span>
          <input id="inBreak" type="number" min="1" max="180" step="1" inputmode="numeric" />
        </label>
      </div>
      <div id="durErr" class="err" role="alert" aria-live="polite" style="display:none;"></div>
      <div class="actions">
        <button class="ghost" id="closeDurBtn">닫기</button>
        <button class="primary" id="saveDurBtn">저장</button>
      </div>
    </div>
  </div>

<script>
/* ==== 엘리먼트 ==== */
const timeText = document.getElementById('timeText');
const subText  = document.getElementById('subText');
const ring     = document.getElementById('ring');
const dial     = document.getElementById('dial');
const timePane = document.getElementById('timePane');

const resetBtn = document.getElementById('resetBtn');
const workBtn  = document.getElementById('workBtn');
const breakBtn = document.getElementById('breakBtn');

const optionsBtn   = document.getElementById('optionsBtn');
const overlayOpt   = document.getElementById('overlayOpt');
const closeOptsBtn = document.getElementById('closeOptsBtn');
const saveOptsBtn  = document.getElementById('saveOptsBtn');

const optSound   = document.getElementById('optSound');
const optVibrate = document.getElementById('optVibrate');
const optFlash   = document.getElementById('optFlash');
const optDebug   = document.getElementById('optDebug');

const debugPanel     = document.getElementById('debugTools');
const btnTestSound   = document.getElementById('btnTestSound');
const btnTestVibrate = document.getElementById('btnTestVibrate');
const btnTestFlash   = document.getElementById('btnTestFlash');
const btnTestSelected= document.getElementById('btnTestSelected');
const btnTestAll     = document.getElementById('btnTestAll');

const durBtn     = document.getElementById('durBtn');
const overlayDur = document.getElementById('overlayDur');
const closeDurBtn= document.getElementById('closeDurBtn');
const saveDurBtn = document.getElementById('saveDurBtn');
const inWork     = document.getElementById('inWork');
const inBreak    = document.getElementById('inBreak');
const durErr     = document.getElementById('durErr');

/* ==== 상태/설정 ==== */
const SETTINGS_KEY = 'pomodoroSettings';
const DUR_KEY      = 'pomodoroDurations';

const settings = { sound:true, vibrate:true, flash:true, debug:false };
const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY) || 'null');
if (saved && typeof saved === 'object'){
  settings.sound   = !!saved.sound;
  settings.vibrate = !!saved.vibrate;
  settings.flash   = !!saved.flash;
  settings.debug   = !!saved.debug;
}
function syncOptionsUI(){
  optSound.checked   = settings.sound;
  optVibrate.checked = settings.vibrate;
  optFlash.checked   = settings.flash;
  optDebug.checked   = settings.debug;
  updateSwitchColor(optSound);
  updateSwitchColor(optVibrate);
  updateSwitchColor(optFlash);
  document.body.classList.toggle('debug-on', settings.debug);
}
syncOptionsUI();

function updateSwitchColor(input) {
  if (input.checked) {
    input.parentElement.classList.add('on');
  } else {
    input.parentElement.classList.remove('on');
  }
}

  
const savedDur = JSON.parse(localStorage.getItem(DUR_KEY) || 'null');
let workDuration  = (savedDur && savedDur.workMin ? savedDur.workMin : 25) * 60;
let breakDuration = (savedDur && savedDur.breakMin ? savedDur.breakMin : 5)  * 60;

/* ==== 링 기하 ==== */
const R = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--radius')) || 160;
const C = 2 * Math.PI * R;
ring.setAttribute('stroke-dasharray', C.toString());
ring.setAttribute('stroke-dashoffset', C.toString());

/* ==== 알림 ==== */
let audioCtx = null;
function ensureAudioCtx(){
  if (!audioCtx){
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
  }
  return audioCtx;
}

/* ==== 화면 깨우기 (Wake Lock: 표준 + iOS 대체) ==== */
let wakeLockSentinel = null; // 표준 스크린 웨이크락
// iOS 사파리 대체: 무음 1x1 비디오를 인라인으로 재생 (NoSleep 기법)
let iOSNoSleepVideo = null;
const iOSNoSleepSrc = 'data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDFtcDQyaXNvbWF2YzEAAAAIZnJlZQAABm1kYXQAAAAAAAABAAACAAAAGQAAABkAAAABAAAAAQAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';

function isIOS(){
  return /iP(ad|hone|od)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
}

async function requestWakeLock(){
  try {
    if ('wakeLock' in navigator && navigator.wakeLock.request){
      wakeLockSentinel = await navigator.wakeLock.request('screen');
      wakeLockSentinel.addEventListener('release', () => { /* released */ });
      return true;
    }
  } catch(e) {
    // 표준 실패 시 iOS 대체 시도
  }
  // iOS 대체
  if (isIOS()){
    if (!iOSNoSleepVideo){
      iOSNoSleepVideo = document.createElement('video');
      iOSNoSleepVideo.setAttribute('playsinline','');
      iOSNoSleepVideo.setAttribute('muted','');
      iOSNoSleepVideo.muted = true;
      iOSNoSleepVideo.loop = true;
      iOSNoSleepVideo.src = iOSNoSleepSrc;
      iOSNoSleepVideo.style.position='fixed';
      iOSNoSleepVideo.style.width='1px';
      iOSNoSleepVideo.style.height='1px';
      iOSNoSleepVideo.style.opacity='0';
      iOSNoSleepVideo.style.pointerEvents='none';
      iOSNoSleepVideo.style.zIndex='-1';
      document.body.appendChild(iOSNoSleepVideo);
    }
    try { await iOSNoSleepVideo.play(); return true; } catch(e) { return false; }
  }
  return false;
}

async function releaseWakeLock(){
  try { if (wakeLockSentinel){ await wakeLockSentinel.release(); } } catch(e){}
  wakeLockSentinel = null;
  if (iOSNoSleepVideo){
    try { iOSNoSleepVideo.pause(); } catch(e){}
  }
}
function beepPattern(){
  const ctx = ensureAudioCtx();
  if (!ctx) return;
  if (ctx.state === 'suspended') { ctx.resume().catch(()=>{}); }
  const now = ctx.currentTime;
  for (let i=0;i<3;i++){
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type='sine'; osc.frequency.value=880;
    g.gain.setValueAtTime(0.0001, now + i*0.3);
    g.gain.exponentialRampToValueAtTime(0.4, now + i*0.3 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.3 + 0.2);
    osc.connect(g).connect(ctx.destination);
    osc.start(now + i*0.3); osc.stop(now + i*0.3 + 0.22);
  }
}
let flashTimer=null;
function startFlash(ms=6000){
  document.body.classList.add('flash');
  clearTimeout(flashTimer);
  flashTimer = setTimeout(()=>document.body.classList.remove('flash'), ms);
}
function vibratePattern(){ if (navigator.vibrate) navigator.vibrate([200,100,200,100,400]); }
function notifySelected(){
  if (settings.sound)   beepPattern();
  if (settings.vibrate) vibratePattern();
  if (settings.flash)   startFlash();
}
function notifyAllForce(){ beepPattern(); vibratePattern(); startFlash(); }

/* ==== 타이머 ==== */
let mode = 'work';                 // 'work' | 'break'
let total = workDuration;
let remaining = total;
let timerId = null;

function format(t){
  const m = Math.floor(t/60).toString().padStart(2,'0');
  const s = Math.floor(t%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}
function setRingColor(){
  ring.setAttribute('stroke', mode==='work'
    ? getComputedStyle(document.documentElement).getPropertyValue('--work')
    : getComputedStyle(document.documentElement).getPropertyValue('--break'));
}
function render(){
  timeText.textContent = format(remaining);
  const progress = 1 - (remaining/total);
  const offset = Math.max(0, Math.min(C, progress*C));
  ring.setAttribute('stroke-dashoffset', offset.toString());
  setRingColor();
}
function start(){
  if (timerId) return;
  ensureAudioCtx();
  subText.textContent = '진행 중…';
  timerId = setInterval(tick, 250);
  requestWakeLock();
}
function pause(){
  if (!timerId) return;
  clearInterval(timerId); timerId=null;
  subText.textContent = '일시정지';
  releaseWakeLock();
}
function reset(){
  clearInterval(timerId); timerId=null;
  remaining = total; render();
  subText.textContent = '탭하여 시작/일시정지';
  releaseWakeLock();
}
function switchMode(next){
  mode = next;
  total = (mode==='work'?workDuration:breakDuration);
  remaining = total;
  workBtn.classList.toggle('active', mode==='work');
  breakBtn.classList.toggle('active', mode==='break');
  render();
}
function tick(){
  remaining = Math.max(0, remaining - 0.25);
  render();
  if (remaining <= 0){
    notifySelected();
    switchMode(mode==='work' ? 'break' : 'work');
    start();
  }
}

/* ==== 이벤트: 타이머/모드 ==== */
const canEditDurations = () => !timerId; // 실행 중이 아닐 때만
// 다이얼(시간 영역 포함) 탭 시 시작/일시정지로만 동작

dial.addEventListener('click', ()=>{
  ensureAudioCtx();
  if (timerId) pause(); else start();
});
// 시간 텍스트 영역도 동일하게(편집 모달 열지 않음)
timePane.addEventListener('click', (e)=>{
  e.stopPropagation();
  ensureAudioCtx();
  if (timerId) pause(); else start();
});
resetBtn.addEventListener('click', reset);
workBtn.addEventListener('click', ()=>{ switchMode('work'); setRingColor(); });
breakBtn.addEventListener('click', ()=>{ switchMode('break'); setRingColor(); });

/* ==== 옵션 모달 ==== */
optionsBtn.addEventListener('click', ()=>{ ensureAudioCtx(); overlayOpt.classList.add('show'); refreshDebugUI(); });
closeOptsBtn.addEventListener('click', ()=> overlayOpt.classList.remove('show'));
saveOptsBtn.addEventListener('click', ()=>{
  settings.sound   = optSound.checked;
  settings.vibrate = optVibrate.checked;
  settings.flash   = optFlash.checked;
  settings.debug   = optDebug.checked;
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  document.body.classList.toggle('debug-on', settings.debug);
  overlayOpt.classList.remove('show');
});
function refreshDebugUI(){ debugPanel.style.display = settings.debug ? 'flex' : 'none'; }
refreshDebugUI();
optDebug.addEventListener('change', ()=>{ settings.debug = optDebug.checked; refreshDebugUI(); });
  
optSound.addEventListener('change', () => updateSwitchColor(optSound));
optVibrate.addEventListener('change', () => updateSwitchColor(optVibrate));
optFlash.addEventListener('change', () => updateSwitchColor(optFlash));
  
btnTestSound.addEventListener('click', ()=>{ ensureAudioCtx(); beepPattern(); });
btnTestVibrate.addEventListener('click', vibratePattern);
btnTestFlash.addEventListener('click', ()=> startFlash());
btnTestSelected.addEventListener('click', ()=>{ ensureAudioCtx(); notifySelected(); });
btnTestAll.addEventListener('click', ()=>{ ensureAudioCtx(); notifyAllForce(); });

/* ==== Durations 모달 ==== */
durBtn.addEventListener('click', ()=>{
  if (!canEditDurations()){ alert('타이머 실행 중에는 편집할 수 없습니다. 먼저 일시정지/리셋하세요.'); return; }
  openDurModal();
});
closeDurBtn.addEventListener('click', closeDurModal);
saveDurBtn.addEventListener('click', ()=>{
  // 검증
  const wm = parseInt(inWork.value,10);
  const bm = parseInt(inBreak.value,10);
  if (!Number.isFinite(wm) || !Number.isFinite(bm) || wm<1 || wm>180 || bm<1 || bm>180){
    showDurError('Work/Break 모두 1~180분 사이의 정수를 입력하세요.');
    return;
  }
  // 저장
  localStorage.setItem(DUR_KEY, JSON.stringify({workMin:wm, breakMin:bm}));
  workDuration  = wm * 60;
  breakDuration = bm * 60;
  // 현재 모드 기준으로 표시 동기화(실행 중이 아닐 때만)
  if (!timerId){
    if (mode==='work'){ total = workDuration; } else { total = breakDuration; }
    remaining = total;
    render();
  }
  closeDurModal();
});
function openDurModal(){
  // 현재 값으로 프리필
  const cur = JSON.parse(localStorage.getItem(DUR_KEY) || 'null');
  inWork.value  = cur && cur.workMin ? cur.workMin : Math.max(1, Math.round(workDuration/60));
  inBreak.value = cur && cur.breakMin ? cur.breakMin : Math.max(1, Math.round(breakDuration/60));
  hideDurError();
  overlayDur.classList.add('show');
}
function closeDurModal(){ overlayDur.classList.remove('show'); }
function showDurError(msg){ durErr.style.display='block'; durErr.textContent=msg; }
function hideDurError(){ durErr.style.display='none'; durErr.textContent=''; }

/* 초기 렌더 */
render();

/* 가시성 변경 시 웨이크락 재요청 (일시 해제 대응) */
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && timerId){
    requestWakeLock();
  }
});

/* PWA: 서비스 워커 등록 */
if ('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
